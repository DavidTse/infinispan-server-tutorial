:toc: left
:toclevels: 4
:source-highlighter: highlightjs
:icons: font
:imagesdir: ./images

image::infinispan_logo.svg[Infinispan Logo]

== Client Server Tutorial
After completing this guide, you will know:

. How to run the Infinispan Server locally
. How to connect to the Infinispan Server web console
. How to create caches in the Infinispan Server
. How to put and read primitive data
. How expiration works
. How client listeners work
. How to put and read non primitive Java Objects
. How to query values

=== 0. Prerequisites

To complete this guide, you need:

- 25 minutes
- an IDE
- JDK 8 or 11+ installed
- Apache Maven 3.6.2.+

TIP: Verify Maven is using the Java you expect
If you have multiple JDKâ€™s installed it is not certain Maven will pick up the expected
java and you could end up with unexpected results. You can verify which JDK Maven uses by
running mvn --version.

=== 1. Run an Infinispan Server locally

For this tutorial, the first thing we need to do is to run an Infinispan Server.

==== Option 1: Use Docker (recommended way)

Use the Infinispan Server docker image to run a standalone infinispan server.

The server is secured by default with a simple security realm.
Provide a USER and PASS. In this tutorial we will be using 'user' and 'pass' credentials.

`docker run -it -p 11222:11222 -e USER="user" -e PASS="pass" infinispan/server:11.0`

==== Option 2: Download the server

- Go to the infinispan https://infinispan.org/download/#stable[downloads] and download the server

- From the installation directory create a user using the Command Line Interface (CLI)
`./bin/cli.sh user create`

- Run the server
`./bin/server.sh`

For this tutorial we will be using 'user' and 'pass' credentials, but feel free to chose your own.

==== Check the Server is correctly running

Open a navigator in `http://localhost:11222/'. The welcome page of the Infinispan Server
should be displayed.

Click on the 'Go to the console button, enter the credentials 'user' and 'pass' and
display the Console Web.

=== 2. Solution

We recommend that you follow the instructions from Boostrapping project and onwards to create the application step by step.

However, you can go right to the completed example.

Download an archive or clone the git repository:

git clone https://github.com/infinispan/infinispan-server-tutorial.git
The solution is located in the 'solution' branch.

=== 3. Architecture

In this tutorial we will build a Weather System.
This system is composed by 4 java applications.

==== Temperature sub-system

The temperature sub-system is composed by two applications:

image::Temperature.png[Temperature.png]

===== Temperature Loader App

The loader application loads the temperatures for all the existing locations.
Infinispan stores the data in the "temperature" cache.

- Location: Key `String`
- Temperature: Value `Float`

This process runs every 5 seconds.

===== Temperature Monitor App

The monitor application monitors the temperature of a specific location. Infinispan sends a
notification, and the application displays a message with the new temperature.

==== Weather sub-system

The weather sub-system is composed by two applications:

image::Weather.png[Weather.png]

===== Weather Loader App

The loader application loads the Weather information for all the existing locations.
Infinispan stores the data in the "weather" cache.

- Location: Key `String`
- Temperature: Value `Float`

This process runs every 5 seconds.

===== Weather Finder App



=== 4. Bootstrapping the project

`git clone https://github.com/infinispan/infinispan-server-tutorial.git`

In the master branch you will have the minimum code and all the place holders to complete this tutorial.

=== 5. Connecting to the Infinispan Server using the Java client

Let's implement the connection to the running Infinispan Server.

==== Maven

To connect to the Infinispan Server using the Java Client, add the hotrod client dependency to the
`pom.xml' file.

.pom.xml
[source,xml]
----
<dependency>
    <groupId>org.infinispan</groupId>
    <artifactId>infinispan-client-hotrod</artifactId>
</dependency>
----

==== Implement the connection


==== Health Check

Run the main class `org.infinispan.tutorial.client.HealthChecker`.
If the connection is correct, you will see:

.HealthChecker
[source,bash]
----

---- Connect to Infinispan ----
INFO: ISPN004021: Infinispan version: Infinispan ...
---- Connection count: 1 ----
---- Shutdown the client ----

----

==== Temperature Monitor App

Change the method "connect" in the DataSourceConnector file.

.db.DataSourceConnector.java
[source,java]
----
ConfigurationBuilder builder = new ConfigurationBuilder();

// Necessary for docker 4 mac
builder.clientIntelligence(ClientIntelligence.BASIC);

// Define a server
builder.addServer()
       .host("127.0.0.1")
       .port(ConfigurationProperties.DEFAULT_HOTROD_PORT);

// Add the credentials you used to run the server
builder.security().authentication().username("admin").password("pass");
----

=== Creating the 'Temperature' cache

Change the method `getTemperatureCache` and get or create a cache using the administrator API.

.db.DataSourceConnector.java
[source,java]
----
public RemoteCache<String, Float> getTemperatureCache() {
   return remoteCacheManager.administration()
              .withFlags(CacheContainerAdmin.AdminFlag.VOLATILE)
              .getOrCreateCache("temperature", DefaultTemplate.DIST_SYNC);
}

----

=== Putting data in the cache

TBD

=== Reading data from the cache

TBD

=== Listening to the changes

TBD

=== Creating a Query

TBD

=== Creating a Continuous Query

TBD

=== Unit testing using Test Containers

TBD

=== What's next?

This guide covered ...


